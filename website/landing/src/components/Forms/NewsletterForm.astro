---
/**
 * Newsletter subscription form
 * Submits to Cloudflare Worker â†’ NocoDB
 */

import Button from "@components/Button/Button.astro";
import { FORM_CONFIG } from "@/config/forms";

interface Props {
  name: string; // name for your form, like "hero-newsletter". It is used for the various id's
  class?: string; // classes for the form
  source?: string; // source identifier (e.g., "footer", "hero", "blog")
  rest?: any; // catch-all for any additional parameters, such as "aria-label"
}

const { name, class: classList, source = "footer", ...rest } = Astro.props as Props;
---

<form
  id={`${name}-form`}
  name={`${name}-form`}
  data-source={source}
  class:list={[
    "newsletter-form border-base-300 bg-base-100/50 dark:border-base-800 dark:bg-base-950 flex justify-between gap-2 rounded-full border p-1 backdrop-blur-sm",
    classList,
  ]}
  {...rest}
>
  <!-- Honeypot field for bot detection -->
  <input type="text" name="website" class="hidden" tabindex="-1" autocomplete="off" />

  <label for={`${name}-email`} class="description text-base-100 sr-only mb-1">*Email</label>
  <input
    type="email"
    class="newsletter__input--focus w-full rounded-full border-none bg-transparent pl-4 transition"
    name="email"
    id={`${name}-email`}
    inputmode="email"
    placeholder="Email"
    required
  />
  <Button variant="primary" type="submit" class="newsletter-btn">
    <span class="btn-text">Subscribe</span>
    <span class="btn-loading hidden">...</span>
  </Button>
</form>

<p id={`${name}-message`} class="text-sm mt-2 hidden"></p>

<style>
  @import "tailwindcss/theme" theme(reference);
  @import "@/styles/tailwind-theme.css" theme(reference);

  .newsletter__input--focus {
    @apply focus:border-primary-600 focus:bg-base-100 focus:ring-offset-base-100 focus-visible:ring-primary-600 focus-visible:ring-2 focus-visible:ring-offset-2;
    @apply dark:focus:bg-base-900 dark:focus:ring-offset-base-900;
  }
</style>

<script define:vars={{ handlerUrl: FORM_CONFIG.handlerUrl, endpoint: FORM_CONFIG.endpoints.subscribe }}>
  document.querySelectorAll('.newsletter-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const formName = form.getAttribute('name');
      const source = form.dataset.source || 'unknown';
      const messageEl = document.getElementById(`${formName.replace('-form', '')}-message`);
      const submitBtn = form.querySelector('.newsletter-btn');

      // Honeypot check
      if (formData.get('website')) {
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.querySelector('.btn-text')?.classList.add('hidden');
      submitBtn.querySelector('.btn-loading')?.classList.remove('hidden');
      messageEl?.classList.add('hidden');

      try {
        const response = await fetch(`${handlerUrl}${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            email: formData.get('email'),
            source: source
          })
        });

        const result = await response.json();

        if (result.success) {
          messageEl.textContent = 'Subscribed! Check your inbox.';
          messageEl.className = 'text-green-500 text-sm mt-2';
          messageEl?.classList.remove('hidden');
          form.reset();
        } else {
          throw new Error(result.error || 'Something went wrong');
        }
      } catch (error) {
        messageEl.textContent = error.message || 'Failed to subscribe. Please try again.';
        messageEl.className = 'text-red-500 text-sm mt-2';
        messageEl?.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.querySelector('.btn-text')?.classList.remove('hidden');
        submitBtn.querySelector('.btn-loading')?.classList.add('hidden');
      }
    });
  });
</script>
