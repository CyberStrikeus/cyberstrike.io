---
/**
 * * Enterprise contact form
 * Submits to Cloudflare Worker â†’ NocoDB
 */

import Button from "@components/Button/Button.astro";
import { FORM_CONFIG } from "@/config/forms";
---

<section id="contact" class="ml-auto max-w-2xl min-w-fit md:max-w-md">
  <form id="contact-form" name="contact" class="flex flex-col gap-4">
    <!-- Honeypot field for bot detection -->
    <input type="text" name="website" class="hidden" tabindex="-1" autocomplete="off" />

    <div class="grid grid-cols-2 gap-4">
      <div class="flex flex-col">
        <label for="contact-fname" class="form__label sr-only">First Name</label>
        <input
          type="text"
          class="form__input"
          name="firstName"
          id="contact-fname"
          placeholder="First name"
          required
        />
      </div>
      <div class="flex flex-col">
        <label for="contact-lname" class="form__label sr-only">Last Name</label>
        <input
          type="text"
          class="form__input"
          name="lastName"
          id="contact-lname"
          placeholder="Last name"
          required
        />
      </div>
    </div>
    <div>
      <label for="contact-email" class="form__label sr-only mb-1">Work Email</label>
      <input
        type="email"
        class="form__input"
        name="email"
        id="contact-email"
        inputmode="email"
        placeholder="Work email"
        required
      />
    </div>
    <div>
      <label for="contact-company" class="form__label sr-only mb-1">Company</label>
      <input
        type="text"
        class="form__input"
        name="company"
        id="contact-company"
        placeholder="Company name"
        required
      />
    </div>
    <div>
      <label for="contact-team-size" class="form__label sr-only mb-1">Team Size</label>
      <select
        name="teamSize"
        class="form__input"
        id="contact-team-size"
        required
      >
        <option value="" disabled selected>Team size</option>
        <option value="1-10">1-10 members</option>
        <option value="11-50">11-50 members</option>
        <option value="51-200">51-200 members</option>
        <option value="200+">200+ members</option>
      </select>
    </div>
    <div>
      <label for="contact-message" class="form__label sr-only mb-1">Message</label>
      <textarea
        name="message"
        class="form__input"
        id="contact-message"
        rows="4"
        placeholder="Tell us about your security needs"
        required></textarea>
    </div>

    <Button variant="primary" type="submit" class="rounded-md before:rounded-md" id="contact-submit-btn">
      <span class="btn-text">Request Demo</span>
      <span class="btn-loading hidden">Sending...</span>
    </Button>

    <p id="contact-error" class="text-red-500 text-sm hidden"></p>
    <p id="contact-success" class="text-green-500 text-sm hidden"></p>
  </form>
</section>

<script define:vars={{ handlerUrl: FORM_CONFIG.handlerUrl, endpoint: FORM_CONFIG.endpoints.contact }}>
  const form = document.getElementById('contact-form');
  const submitBtn = document.getElementById('contact-submit-btn');
  const errorEl = document.getElementById('contact-error');
  const successEl = document.getElementById('contact-success');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);

    // Honeypot check
    if (formData.get('website')) {
      return; // Bot detected
    }

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.querySelector('.btn-text')?.classList.add('hidden');
    submitBtn.querySelector('.btn-loading')?.classList.remove('hidden');
    errorEl?.classList.add('hidden');
    successEl?.classList.add('hidden');

    try {
      const response = await fetch(`${handlerUrl}${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(Object.fromEntries(formData))
      });

      const result = await response.json();

      if (result.success) {
        successEl.textContent = 'Thank you! We\'ll be in touch soon.';
        successEl?.classList.remove('hidden');
        form.reset();
      } else {
        throw new Error(result.error || 'Something went wrong');
      }
    } catch (error) {
      errorEl.textContent = error.message || 'Failed to submit. Please try again.';
      errorEl?.classList.remove('hidden');
    } finally {
      submitBtn.disabled = false;
      submitBtn.querySelector('.btn-text')?.classList.remove('hidden');
      submitBtn.querySelector('.btn-loading')?.classList.add('hidden');
    }
  });
</script>
