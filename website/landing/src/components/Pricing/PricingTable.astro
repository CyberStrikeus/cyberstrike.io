---
/**
 * * Pricing section table with toggle for monthly or yearly payments
 * This is designed for 4 pricing plans with feature comparison grid
 */

import Button from "@components/Button/Button.astro";
import { getLocaleFromUrl } from "@js/localeUtils";
import { Icon } from "astro-icon/components";

import { Switch } from "@/components/starwind/switch";
import { getLocalizedRoute } from "@/js/translationUtils";

interface planInfo {
  name: string;
  featured?: boolean;
  price: {
    monthly: number;
    yearly: number;
  };
}

interface featureRow {
  feature: string;
  plans: (boolean | string)[];
}

interface featureGrouping {
  title: string;
  features: featureRow[];
}

interface pricingTable {
  plans: planInfo[];
  featureTable: featureGrouping[];
}

const pricingData: pricingTable = {
  plans: [
    {
      name: "Hacker",
      price: {
        monthly: 0,
        yearly: 0,
      },
    },
    {
      name: "Pro",
      price: {
        monthly: 29,
        yearly: 313,
      },
    },
    {
      name: "Elite",
      featured: true,
      price: {
        monthly: 59,
        yearly: 637,
      },
    },
    {
      name: "Enterprise",
      price: {
        monthly: -1,
        yearly: -1,
      },
    },
  ],
  featureTable: [
    {
      title: "AI Agents",
      features: [
        { feature: "Cloud Security Agent", plans: [true, true, true, true] },
        { feature: "Internal Network Agent", plans: [true, true, true, true] },
        { feature: "Red Team Agent", plans: [true, true, true, true] },
        { feature: "Web Application Agent", plans: [true, true, true, true] },
        { feature: "Bug Hunter Agent", plans: [true, true, true, true] },
      ],
    },
    {
      title: "Infrastructure",
      features: [
        { feature: "Local execution", plans: [true, true, true, true] },
        { feature: "Remote servers", plans: [false, false, "Up to 5", "Unlimited"] },
        { feature: "Job Queue", plans: [false, false, true, true] },
        { feature: "On-premise deployment", plans: [false, false, false, true] },
      ],
    },
    {
      title: "Core Features",
      features: [
        { feature: "CLI & Desktop App", plans: [true, true, true, true] },
        { feature: "Custom Agents", plans: [true, true, true, true] },
        { feature: "Kali Tools MCP", plans: [false, true, true, true] },
        { feature: "Hacker Browser MCP", plans: [false, false, true, true] },
        { feature: "BYOK (Bring Your Own Key)", plans: [true, true, true, true] },
        { feature: "BYOA (Bring Your Own AI)", plans: [false, false, false, true] },
      ],
    },
    {
      title: "Support",
      features: [
        { feature: "Community support", plans: [true, true, true, true] },
        { feature: "Priority support", plans: [false, true, true, true] },
        { feature: "Dedicated account manager", plans: [false, false, false, true] },
      ],
    },
  ],
};

const currLocale = getLocaleFromUrl(Astro.url);

// Button config per plan
const getButtonConfig = (plan: planInfo) => {
  if (plan.price.monthly === 0) {
    return { href: "https://github.com/CyberStrikeus/cyberstrike.io", text: "Download Free", target: "_blank" };
  } else if (plan.price.monthly === -1) {
    return { href: getLocalizedRoute(currLocale, "/contact"), text: "Contact Sales", target: undefined };
  } else {
    return { href: getLocalizedRoute(currLocale, "/waitlist"), text: "Join Waitlist", target: undefined };
  }
};
---

<section id="pricing" class="py-16 md:py-20">
  <div class="site-container relative">
    <div class="flex justify-center">
      <h2 class="h2 inline text-center">Simple, transparent pricing</h2>
    </div>
    <p class="description text-center mt-4 max-w-2xl mx-auto">
      You bring the AI, we provide the weapons. All plans include BYOK.
    </p>

    <!-- Toggle switch for monthly or yearly pricing -->
    <div class="mt-6 flex justify-center">
      <label
        for="pricing-table__toggle"
        class="relative inline-flex cursor-pointer items-center gap-4 select-none"
      >
        <span class="description flex items-center">Monthly</span>
        <Switch id="pricing-table__toggle" variant="primary" padding={4} />
        <span class="description flex items-center">
          Yearly
          <span class="ml-2 text-xs bg-primary-500/20 text-primary-400 px-2 py-0.5 rounded-full">Save 10%</span>
        </span>
      </label>
    </div>

    <!-- Pricing grid: 5 columns (1 feature label + 4 plans) -->
    <div class="mx-auto mt-12 grid w-full grid-cols-4 md:mt-20 lg:grid-cols-5">
      <!-- pricing plan top info -->
      <div class="col-span-4 grid gap-3 md:grid-cols-4 lg:col-start-2 lg:gap-0">
        {
          pricingData.plans.map((plan, planIdx) => (
            <div class="pricing-plan relative mx-auto h-full w-full max-w-sm rounded-2xl lg:rounded-b-none">
              <div class="relative h-full lg:pb-0">
                <div
                  class="relative z-10 flex h-full flex-col rounded-t-xl rounded-b-xl lg:rounded-b-none"
                  class:list={[
                    {
                      "border-primary-500 bg-base-50 dark:bg-base-900 border-2 lg:border-b-0 shadow-[0_0_40px_-5px_rgba(59,130,246,0.5)] before:absolute before:-inset-[2px] before:-z-10 before:rounded-xl before:bg-primary-500/20 before:blur-xl":
                        plan.featured === true,
                    },
                  ]}
                >
                  {plan.featured && (
                    <div class="absolute -top-3 left-1/2 -translate-x-1/2 z-20">
                      <span class="bg-primary-500 text-white text-xs font-semibold px-4 py-1 rounded-full shadow-lg">
                        Most Popular
                      </span>
                    </div>
                  )}
                  <div class="mx-auto flex h-full w-full max-w-[20rem] flex-col px-6 pb-6 text-center">
                    <div class="flex w-full justify-center pt-6">
                      <h3
                        class="mb-8 text-lg font-medium tracking-tight"
                        class:list={[
                          {
                            "text-primary-600 dark:text-primary-400": plan.featured === true,
                          },
                          {
                            "text-base-800 dark:text-base-300": plan.featured !== true,
                          },
                        ]}
                      >
                        {plan.name}
                      </h3>
                    </div>
                    <div class="text-center">
                      <p class="mt-3 font-medium">
                        {plan.price.monthly === 0 ? (
                          <div>
                            <h4 class="text-4xl font-medium tracking-tight">Free</h4>
                            <span class="description inline-block text-sm tracking-tight">
                              open source forever
                            </span>
                          </div>
                        ) : plan.price.monthly === -1 ? (
                          <div>
                            <h4 class="text-4xl font-medium tracking-tight">Custom</h4>
                            <span class="description inline-block text-sm tracking-tight">
                              per seat pricing
                            </span>
                          </div>
                        ) : (
                          <div>
                            <div class="pricing-monthly">
                              <h4 class="text-4xl font-medium tracking-tight">${plan.price.monthly}/mo</h4>
                              <span class="description inline-block text-sm tracking-tight">
                                billed monthly
                              </span>
                            </div>
                            <div class="pricing-yearly hidden">
                              <h4 class="text-4xl font-medium tracking-tight">${plan.price.yearly}/yr</h4>
                              <span class="description inline-block text-sm tracking-tight">
                                billed yearly (save 10%)
                              </span>
                            </div>
                          </div>
                        )}
                      </p>
                    </div>

                    <ul class="mt-4 flex w-full flex-col gap-2 lg:sr-only">
                      {pricingData.featureTable.map((featureGroup) =>
                        featureGroup.features.map(
                          (featureRow) =>
                            featureRow.plans[planIdx] !== false && (
                              <li
                                class:list={[
                                  "flex items-start",
                                  {
                                    "opacity-90": plan.featured !== true,
                                  },
                                ]}
                              >
                                <Icon
                                  name="tabler/check"
                                  class="text-primary-600 dark:text-primary-400 mt-0.5 size-5 shrink-0"
                                  aria-hidden="true"
                                />
                                <span class="ml-2 inline text-left leading-tight">
                                  {featureRow.feature}
                                  <span>
                                    {typeof featureRow.plans[planIdx] === "string" && (
                                      <span class="text-base-700 dark:text-base-300 ml-1 text-sm">
                                        ({featureRow.plans[planIdx]})
                                      </span>
                                    )}
                                  </span>
                                </span>
                              </li>
                            ),
                        ),
                      )}
                    </ul>
                    <div class="mt-auto">
                      <Button
                        variant={plan.featured === true ? "primary" : "outline"}
                        href={getButtonConfig(plan).href}
                        target={getButtonConfig(plan).target}
                        class={`mt-4 py-1.5`}
                      >
                        {getButtonConfig(plan).text}
                      </Button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))
        }
      </div>

      <!-- feature rows for desktop -->
      <div class="col-span-5 hidden lg:block">
        {
          pricingData.featureTable.map((featureGroup, groupIdx) => (
            <div>
              <div class="border-base-300 dark:border-base-700 grid grid-cols-5 border-b text-lg">
                <p class="pt-6 pb-2 font-medium">{featureGroup.title}</p>
                {pricingData.plans.map((plan) => (
                  <div
                    class:list={[
                      {
                        "border-primary-500 border-x-2 bg-primary-500/5 dark:bg-primary-500/10 shadow-[inset_0_0_20px_rgba(59,130,246,0.15)]":
                          plan.featured === true,
                      },
                    ]}
                  />
                ))}
              </div>
              {featureGroup.features.map((feature, featureIdx) => (
                <div class="border-base-300 dark:border-base-700 grid grid-cols-5 border-b">
                  <p class="py-2 opacity-90 dark:opacity-80">{feature.feature}</p>
                  {feature.plans.map((planValue, planIdx) => (
                    <div
                      class="flex items-center justify-center py-2"
                      class:list={[
                        {
                          "border-primary-500 border-x-2 bg-primary-500/5 dark:bg-primary-500/10 shadow-[inset_0_0_20px_rgba(59,130,246,0.15)]":
                            pricingData.plans[planIdx].featured,
                        },
                      ]}
                    >
                      {typeof planValue === "string" ? (
                        <span
                          class={
                            pricingData.plans[planIdx].featured === true
                              ? "font-medium"
                              : "opacity-90 dark:opacity-80"
                          }
                        >
                          {planValue}
                        </span>
                      ) : planValue === false ? (
                        <Icon
                          name="tabler/minus"
                          class="size-3 shrink-0 opacity-90 dark:opacity-80"
                          aria-hidden="true"
                        />
                      ) : (
                        <Icon
                          name="tabler/check"
                          class={`text-primary-600 dark:text-primary-400 size-5 shrink-0 ${
                            pricingData.plans[planIdx].featured === true
                              ? ""
                              : "opacity-90 dark:opacity-80"
                          }`}
                          aria-hidden="true"
                        />
                      )}
                    </div>
                  ))}
                </div>
              ))}
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  import type { SwitchChangeEvent } from "@/components/starwind/switch";

  function pricingPlanToggleSetup() {
    const pricingSection = document.getElementById("pricing");
    const toggle = pricingSection?.querySelector("#pricing-table__toggle");
    const monthlyPrices = pricingSection?.querySelectorAll(".pricing-monthly");
    const yearlyPrices = pricingSection?.querySelectorAll(".pricing-yearly");

    if (!toggle || !monthlyPrices || !yearlyPrices) return;

    toggle.addEventListener("starwind-switch:change", (e: Event) => {
      const event = e as SwitchChangeEvent;
      const isYearly = event.detail.checked;

      monthlyPrices.forEach((price) => price.classList.toggle("hidden", isYearly));
      yearlyPrices.forEach((price) => price.classList.toggle("hidden", !isYearly));
    });
  }

  pricingPlanToggleSetup();
  document.addEventListener("astro:after-swap", pricingPlanToggleSetup);
</script>
