name: "PR: Auto Label"

on:
  pull_request:
    types: [opened, edited, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Label PR based on title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title.toLowerCase();
            const labels = [];

            // Conventional commit prefixes
            if (title.startsWith('feat')) labels.push('feature');
            if (title.startsWith('fix')) labels.push('bug');
            if (title.startsWith('docs')) labels.push('documentation');
            if (title.startsWith('style')) labels.push('style');
            if (title.startsWith('refactor')) labels.push('refactor');
            if (title.startsWith('perf')) labels.push('performance');
            if (title.startsWith('test')) labels.push('testing');
            if (title.startsWith('chore')) labels.push('chore');
            if (title.startsWith('ci')) labels.push('ci');
            if (title.startsWith('build')) labels.push('build');

            // Scope-based labels
            if (title.includes('(cli)')) labels.push('cli');
            if (title.includes('(tui)')) labels.push('tui');
            if (title.includes('(sdk)')) labels.push('sdk');
            if (title.includes('(docs)')) labels.push('docs');
            if (title.includes('(web)')) labels.push('web');
            if (title.includes('(agent)')) labels.push('agents');
            if (title.includes('(mcp)')) labels.push('mcp');
            if (title.includes('(security)')) labels.push('security');
            if (title.includes('(deps)')) labels.push('dependencies');

            // Priority labels based on keywords
            if (title.includes('breaking') || title.includes('!:')) labels.push('breaking-change');
            if (title.includes('urgent') || title.includes('critical')) labels.push('priority-high');
            if (title.includes('wip') || title.includes('draft')) labels.push('work-in-progress');

            // Dependabot
            if (context.payload.pull_request.user.login === 'dependabot[bot]') {
              labels.push('dependencies');
              labels.push('automated');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
              console.log(`Added labels: ${labels.join(', ')}`);
            } else {
              console.log('No matching labels found for this PR');
            }

      - name: Label PR based on files changed
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const labels = new Set();

            for (const file of files) {
              const path = file.filename;

              // Package-specific labels
              if (path.startsWith('packages/cyberstrike/')) labels.add('cli');
              if (path.startsWith('packages/web/')) labels.add('web');
              if (path.startsWith('packages/sdk/')) labels.add('sdk');
              if (path.startsWith('packages/desktop/')) labels.add('desktop');
              if (path.startsWith('packages/mcp-kali/')) labels.add('mcp');

              // Documentation
              if (path.startsWith('docs/') || path.endsWith('.md') || path.endsWith('.mdx')) {
                labels.add('documentation');
              }

              // CI/CD
              if (path.startsWith('.github/')) labels.add('ci');

              // Configuration
              if (path.includes('config') || path.endsWith('.json') || path.endsWith('.yml')) {
                labels.add('configuration');
              }

              // Tests
              if (path.includes('test') || path.includes('spec')) labels.add('testing');
            }

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: [...labels]
              });
              console.log(`Added file-based labels: ${[...labels].join(', ')}`);
            }
